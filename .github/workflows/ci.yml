name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  workflow_dispatch:

env:
  NODE_VERSION: '20.x'

jobs:
  # ============================================
  # SECURITY AUDIT
  # ============================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'
      
      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: Run npm audit
        # Continue on error because audit failures shouldn't always block (unless critical)
        # You can remove "|| true" to make it strict
        run: npm run audit:ci || true

  # ============================================
  # LINT & TYPE CHECK
  # ============================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: Lint (Client & Server)
        run: |
          cd client && npm run lint
          cd ../server && npm run lint

      - name: Type Check (Client & Server)
        run: |
          cd client && npm run type-check
          cd ../server && npm run type-check

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: Client Tests
        run: cd client && npm run test:ci:stable

      - name: Server Tests
        run: cd server && npm run test:coverage:ci

      # Upload coverage if needed (Codecov token required in secrets)
      # - name: Upload coverage
      #   uses: codecov/codecov-action@v3
      #   ...

  # ============================================
  # E2E TESTS (Cypress)
  # ============================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests] # Run E2E only if basic checks pass
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '7.0'

      - name: Build & Start Backend
        run: |
          cd server
          npm run build
          npm start &
        env:
          MONGODB_URI: mongodb://localhost:27017/skproduction-test
          JWT_SECRET: test-secret
          NODE_ENV: test
          PORT: 5001

      - name: Build & Start Frontend
        run: |
          cd client
          npm run build
          npm start &
        env:
          NEXT_PUBLIC_API_URL: http://localhost:5001/api
          NEXT_PUBLIC_BACKEND_URL: http://localhost:5001
          PORT: 3000

      - name: Wait for Servers
        run: |
          npx wait-on http://localhost:5001/api/health http://localhost:3000 --timeout 120000

      - name: Run Cypress
        uses: cypress-io/github-action@v6
        with:
          working-directory: client
          install: false
          # Servers are already started above
          wait-on: 'http://localhost:3000'
        env:
          CYPRESS_baseUrl: http://localhost:3000

      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: cypress-screenshots
          path: client/cypress/screenshots

  # ============================================
  # BUILD CHECK
  # ============================================
  build:
    name: Production Build Check
    runs-on: ubuntu-latest
    needs: [unit-tests] # Parallel with E2E
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci

      - name: Build Client
        run: cd client && npm run build
        env:
          NEXT_PUBLIC_API_URL: https://api.skproduction.com/api # Placeholder for build
          NEXT_PUBLIC_BACKEND_URL: https://api.skproduction.com

      - name: Build Server
        run: cd server && npm run build
