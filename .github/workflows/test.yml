name: Comprehensive Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          cd client
          npm ci
      
      - name: Run Linting
        run: cd client && npm run lint
      
      - name: Run Type Checking
        run: cd client && npm run type-check
      
      - name: Run Unit Tests
        run: cd client && npm run test:ci
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./client/coverage/lcov.info
          flags: frontend

  backend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          cd server
          npm ci
      
      - name: Run Linting
        run: cd server && npm run lint
      
      - name: Run Type Checking
        run: cd server && npm run type-check
      
      - name: Run Unit Tests
        run: cd server && npm run test:coverage
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./server/coverage/lcov.info
          flags: backend

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Dependencies
        run: |
          npm ci
          cd client && npm ci
          cd ../server && npm ci
      
      - name: Start MongoDB
        uses: supercharge/mongodb-github-action@1.10.0
        with:
          mongodb-version: '7.0'
      
      - name: Start Backend Server
        run: |
          cd server
          npm run build
          npm start &
        env:
          MONGODB_URI: mongodb://localhost:27017/skproduction-test
          JWT_SECRET: test-secret
          NODE_ENV: test
      
      - name: Start Frontend Server
        run: |
          cd client
          npm run build
          npm start &
        env:
          NEXT_PUBLIC_API_URL: http://localhost:5001/api
      
      - name: Wait for Servers
        run: |
          npx wait-on http://localhost:5001/api/health http://localhost:3000 --timeout 60000
      
      - name: Run E2E Tests
        run: cd client && npm run cypress:run
      
      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: cypress-screenshots
          path: client/cypress/screenshots

  test-summary:
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, e2e-tests]
    if: always()
    steps:
      - name: Test Summary
        run: |
          echo "## Test Sonuçları" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend Tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Backend Tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY

